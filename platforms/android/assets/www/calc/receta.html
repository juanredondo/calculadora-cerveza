<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<html>
	<style type="text/css">
		* {
			font-family: sans-serif;
			font-size: 12px;
			margin-left: 2px;
		}

		fieldset {
			margin-bottom: 10px;
			padding: 10px;
			border: 1px solid #c0c0c0;
			border-radius: 5px;
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
		}

		legend {
			font-size: medium;
		}

		[type=text], [type=button], textarea {
			margin-top: 3px;
			padding: 1px;
			border: 1px solid #000000;
			border-radius: 3px;
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
		}

		label {

			float: left;
		}

		input:hover, textarea:hover, input:focus, textarea:focus {
			background-color: #ddffdd;
		}

		table {
			border-width: 0px;
			border-spacing: 0px;
			border-style: none;
			padding-bottom: 10px;
		}

		table.results {
			border-width: 1px;
			border-spacing: 0px;
			padding-bottom: 10px;
		}

		table.results td {
			border-bottom: solid 1px black;
		}

		table.results tr {
			border-bottom: 1px;
		}

		table td {
			border-width: 0px;
			padding-left: 7px;
		}

		div.values {
			float: left;
			margin-right: 0px;
			width: 30%;
		}

		table.result td {
			font-weight: bold;
			font-size: medium;
			padding-top: 20px;
			padding-left: 10px;
		}

		table.result td.value {
			font-size: medium;
			color: red;
		}

		input.data {
			margin-left: 8px;
		}

		input.option {
			background-color: #FFFFCC;
		}

		div.visible {
			z-index: 100;
			width: 500px;
			height: 475px;
			position: absolute;
			left: 50%;
			top: 5px;
			margin: 0 0 0 -250px;
			display: block;
			overflow: hidden;
			background-color: #FFFFFF;
			padding: 5px 5px 5px 5px;
			display: inline;
		}

		div.help {
			z-index: 100;
			width: 700px;
			height: 600px;
			position: absolute;
			left: 50%;
			top: 5px;
			margin: 0 0 0 -400px;
			display: block;
			background-color: #FFFFFF;
			padding: 5px 5px 5px 5px;
			display: inline;
		}

		div.help * {
			font-size: 12px;
		}

		div.invisible {
			position: absolute;
			width: 0px;
			height: 0px;
			z-index: -1;
			display: none;
		}

		div.fadeMe {
			opacity: 0.85;
			background: #000;
			width: 100%;
			height: 100%;
			z-index: 10;
			top: 0;
			left: 0;
			position: fixed;
		}

		div.formtext {
			z-index: 100;
			width: 500px;
			height: 475px;
			position: absolute;
			left: 50%;
			top: 5px;
			margin: 0 0 0 -250px;
			display: block;
			overflow: hidden;
			background-color: #FFFFFF;
			padding: 5px 5px 5px 5px;
			display: inline;
		}

		textarea {
			width: 470;
			height: 375;
			position: absolute;
			left: 15px;
			top: 40px;
			display: block;
		}

		input.closebutton {
			position: absolute;
			top: 430px;
			left: 5px;
		}

	</style>
	<head>
		<SCRIPT TYPE="text/javascript" LANGUAGE="javascript" SRC="script/jquery-1.8.3.min.js"></SCRIPT>
		<script type="text/JavaScript">
			/**
			 * @author Raul Hevia Casielles
			 */

			var grainList;
			var numGrain = 8;
			var textPlain = "";
			var textForum = "";

			function grainVO(name, ep, weight, percent) {
				this.name = name;
				this.ep = ep;
				this.weight = weight;
				this.percent = percent;
			}

			function populateGrainSeleccion() {
				writeGrainSelection();

				var options = ["", "", "Malta Pale", "80", "Malta Pilsen", "80", "Malta Crystal 120 EBC", "74", "Malta Chocolate 900 EBC", "65", "Malta Black 1000 EBC", "60", "Malta de Trigo", "84", "Malta Munich 16 EBC", "80", "Malta Ámbar 70 EBC", "70", "Copos de Maíz", "86", "Copos de Cebada", "70", "Azúcares", "100", "Otro", ""];

				for(var i = 0; i < (options.length / 2); i++) {
					for(var j = 1; j <= numGrain; j++) {
						document.getElementById("grain" + j).options[i] = new Option(options[i * 2], options[(i * 2) + 1]);
					}
				}
			}

			function writeGrainSelection() {
				var grainSelection = "<tr><td></td><td>Ingrediente</td><td><nobr>Extracto (%)</nobr></td><td><nobr>Porcentaje (%)</nobr></td><td><nobr>Peso (Kg)</nobr></td></tr>";

				for(var i = 1; i <= numGrain; i++) {
					grainSelection += "<tr><td><nobr>" + i + "</nobr></td><td><select id='grain" + i + "' name = 'grain" + i + "' onchange='onGrainOptionChange(this);'></select></td>" + "<td><input type='text' name = 'extract" + i + "' style='width: 50px' /></td>" + "<td><input type='text' class='option' name = 'percent" + i + "' style='width: 50px' /></td>" + "<td><input type='text' class='option' name = 'weight" + i + "' style='width: 70px' /></td></tr>";

				}
				$("#grainTable").empty();
				$("#grainTable").append(grainSelection);
			}

			function onGrainOptionChange(option) {
				var index = option.name.substring(5);
				document.recipeTool.elements["extract" + index].value = option.value;
				document.recipeTool.elements["weight" + index].value = "";
				document.recipeTool.elements["percent" + index].value = "";
				if(document.recipeTool.elements["extract" + index].value.length == 0)
					document.recipeTool.elements["extract" + index].focus();
				else
					document.recipeTool.elements["percent" + index].focus();
			}

			function recipeCalc() {
				var calculateMalt = true;

				if(!check(document.recipeTool.volume, "Volumen inicial en litros"))
					return;
				if(!check(document.recipeTool.efficiency, "Rendimiento del equipo (%)"))
					return;
				//if (!check(document.recipeTool.boilTime, "Tiempo de hervido (minuos)")) return;
				//if (!check(document.recipeTool.boilEvap, "Perdida por evaporación en una hora (litros)")) return;

				if(!getGrainValues())
					return;

				calculateGrainPercent();

				var efficiency = parseFloatEx(document.recipeTool.efficiency.value);
				var volume = parseFloatEx(document.recipeTool.volume.value);
				var boilTime = parseFloatEx(document.recipeTool.boilTime.value);
				var boilEvap = parseFloatEx(document.recipeTool.boilEvap.value);
				var og = parseFloatEx(document.recipeTool.hydrometer.value);
				var mashRel = parseFloatEx(document.recipeTool.mash.value);
				var volumePreBoil = "";
				var ig = "";

				if(isNumber(grainList[0].weight)) {
					if(og.length == 0 || isNaN(og)) {
						og = calculateOG(efficiency, volume);
						calculateMalt = false;
					}
				}

				if(og.toString().indexOf('.') != -1)
					og = og * 1000;
				og = round(og, 0);

				if(isNumber(boilEvap) && isNumber(boilTime)) {
					//Volumen antes de hervir
					volumePreBoil = volume + boilEvap * (boilTime / 60);
					//Densidad antes de hervir
					ig = (og * volume + 1000 * (volumePreBoil - volume)) / volumePreBoil;
				}
				//Extracto necesario (gr/L)
				var eg = og * (259 - (259000 / og)) / 100;
				//Extracto necesario (Kg)
				var ek = volume * eg / (efficiency / 100) / 1000;
				//Calcular pesos de las maltas
				if(calculateMalt)
					calculateMaltWeight(ek);
				//Calcular peso total de las maltas
				var totalWeight = getTotalMaltWeight();

				//Calcular macerado si se ha indicado relacion de empaste
				var mashVolume = "";
				var mashBatchVolume = "";
				var spargeVolume = "";
				var totalWater = "";
				
				if(isNumber(mashRel)) {
					mashVolume = totalWeight * mashRel;
					mashBatchVolume = totalWeight * (mashRel + 0.67);
					spargeVolume = volumePreBoil + (totalWeight * 1.08) - mashVolume;
					totalWater = mashVolume + spargeVolume;
					mashVolume = round(mashVolume, 1);
					mashBatchVolume = round(mashBatchVolume, 1);
					spargeVolume = round(spargeVolume, 1);
					totalWater = round(totalWater, 1);
				}

				writeMaltResult(totalWeight);
				writeMashResult(mashVolume, mashBatchVolume, spargeVolume, totalWater);
				writeBoilResult(volumePreBoil, ig);
				writeFerResult(volume, og);

				setResultsVisible(true);
				
				setCopyText(totalWeight, mashVolume, mashBatchVolume, spargeVolume, totalWater, volumePreBoil, ig, volume, og);
			}

			function recipeCalcClear() {
				document.recipeTool.hydrometer.value = "";
				document.recipeTool.volume.value = "";
				document.recipeTool.efficiency.value = "";
				document.recipeTool.mash.value = "";
				document.recipeTool.boilTime.value = "";
				document.recipeTool.boilEvap.value = "";

				for(var i = 1; i <= 8; i++) {
					eval("document.recipeTool.grain" + i).selectedIndex = 0;
					eval("document.recipeTool.extract" + i).value = "";
					eval("document.recipeTool.weight" + i).value = "";
					eval("document.recipeTool.percent" + i).value = "";
				}
			}

			function writeMaltResult(totalWeight) {
				var table = "";

				table += "<tr><td><b>Ingrediente</b></td><td><b>Porcentaje(%)</b></td><td><b>Peso (kg)</b></td></tr>";

				for(var i = 0; i < grainList.length; i++) {
					table += "<tr><td>" + grainList[i].name + "</td>" + "<td>" + grainList[i].percent + "</td>" + "<td>" + round(grainList[i].weight, 2) + "</td></tr>";
				}

				table += "<tr></tr><tr><td><b>Total:</b></td><td>&nbsp;</td><td>" + round(totalWeight, 3) + "</td></tr>";

				$("#maltResult").empty();
				$("#maltResult").append(table);
			}

			function writeMashResult(mashVolume, mashBatchVolume, spargeVolume, totalWater) {
				if(isNumber(mashVolume)) {
					table = writeTr("Agua para el macerado:", mashVolume + " litros.");
					table += writeTr("Volumen que ocupara el macerado:", mashBatchVolume + " litros.");
					table += writeTr("Agua para el lavado:", spargeVolume + " litros.");
					table += writeTr("Agua total necesaria:", totalWater + " litros.");
				} else {
					table = writeTr("Sin datos", "Debe indicar la relación de empaste.")
				}

				$("#mashResult").empty();
				$("#mashResult").append(table);
			}

			function writeBoilResult(volumePreBoil, ig) {
				if(isNumber(volumePreBoil)) {
					table = writeTr("Volumen de mosto en olla:", round(volumePreBoil, 1) + " litros.");
					table += writeTr("Densidad antes de hervir:", round(ig, 0));
				} else {
					table = writeTr("Sin datos", "Debe indicar evaporación y tiempo de hervido.");
				}

				$("#boilResult").empty();
				$("#boilResult").append(table);
			}

			function writeFerResult(volume, og) {
				table = writeTr("Volumen inicial:", round(volume, 1) + " litros.");
				table += writeTr("Densidad inicial:", round(og, 0));

				$("#ferResult").empty();
				$("#ferResult").append(table);
			}

			function writeTr(label, value) {
				return "<tr><td><b>" + label + "</b></td><td>" + value + "</td></tr>";
			}

			function getTotalMaltWeight() {
				var w = 0;
				for(var i = 0; i < grainList.length; i++) {
					w += grainList[i].weight;
				}
				return w;
			}

			function calculateMaltWeight(ek) {
				for(var i = 0; i < grainList.length; i++) {
					var w = (ek * grainList[i].percent) / grainList[i].ep;
					grainList[i].weight = w;
				}
			}

			function calculateOG(efficiency, volume) {
				var et = 0;

				for(var i = 0; i < grainList.length; i++) {
					et += ((grainList[i].weight * 1000) * (grainList[i].ep / 100) * (efficiency / 100));
				}

				var c = et / volume;
				var og = (0.3838 * c) + 1000;
				return round(og, 0);
			}

			function getGrainValues() {
				var numWeight = 0;
				var numPercent = 0;

				grainList = new Array();

				for(var i = 1; i <= numGrain; i++) {
					var name = getSelectedText("grain" + i);
					var ep = parseFloatEx(eval("document.recipeTool.extract" + i).value);
					var weight = parseFloatEx(eval("document.recipeTool.weight" + i).value);
					var percent = parseFloatEx(eval("document.recipeTool.percent" + i).value);

					if(ep.length != 0 && !isNaN(ep) && ((weight.length != 0 && !isNaN(weight)) || (percent.length != 0 && !isNaN(percent)) )) {
						grainList[grainList.length] = new grainVO(name, ep, weight, percent);
						if(weight.length != 0 && !isNaN(weight))
							numWeight++;
						if(percent.length != 0 && !isNaN(percent))
							numPercent++;
					}
				}

				if(grainList.length == 0) {
					alert("Debe indicar almenos un ingrediente para realizar el cálculo");
					return false;
				}

				if(numPercent > 0 && numWeight > 0) {
					alert("Para todos los ingredientes debe indicar o porcentajes o pesos, no es posible una mezcla de datos.");
					return false;
				}

				var og = parseFloatEx(document.recipeTool.hydrometer.value);

				if(numWeight == 0 && (og.length == 0 || isNaN(og))) {
					alert("Si la cantidad se indica en porcentajes la densidad inicial es un dato necesario para realizar el cálculo.");
					return;
				}

				var totalPercent = 0;

				if(numPercent > 0) {
					for(var i = 0; i < grainList.length; i++) {
						totalPercent += parseFloatEx(grainList[i].percent);
					}
					if(totalPercent != 100) {
						alert("La suma de los porcentajes de los ingredientes debe de ser el 100% [Suma = " + totalPercent + "]");
						return false;
					}
				}

				return true;
			}

			function calculateGrainPercent() {

				if(grainList[0].percent.length == 0 || isNaN(grainList[0].percent)) {
					var totalWeight = 0;

					for(var i = 0; i < grainList.length; i++) {
						totalWeight += grainList[i].weight;
					}

					for(var i = 0; i < grainList.length; i++) {
						grainList[i].percent = round((grainList[i].weight * 100) / totalWeight, 0);
					}
				}

			}

			function getSelectedText(elementId) {
				var elt = document.getElementById(elementId);

				if(elt.selectedIndex == -1)
					return null;

				return elt.options[elt.selectedIndex].text;
			}

			function getPotential(index) {
				var extract = document.efficiencyTool.elements["extract" + index].value.replace(",", ".");
				var weight = document.efficiencyTool.elements["weight" + index].value.replace(",", ".");

				if(extract.length == 0 || isNaN(extract) || weight.length == 0 || isNaN(weight))
					return 0;

				return parseFloat(weight) * (parseFloat(extract) / 100);
			}

			function getWeight(index) {
				var weight = document.efficiencyTool.elements["weight" + index].value.replace(",", ".");

				if(weight.length == 0 || isNaN(weight))
					return 0;
				return parseFloat(weight);
			}

			function check(input, text) {
				if(input.value.length == 0 || isNaN(input.value.toString().replace(",", "."))) {
					alert("El valor de [" + text + "] no es correcto.");
					input.focus();
					input.select();
					return false;
				}
				return true;
			}

			function round(number, off) {
				i = Math.pow(10, off)
				return (Math.round(number * i) / i).toFixed(off).replace(".", ",");
			}

			function parseFloatEx(value) {
				if(!isNumber(value))
					return "";

				return parseFloat(value.toString().replace(",", "."));
			}

			function getPlato(density) {
				return 260 - (260 / parseFloatEx(density));
			}

			function setResultsVisible(visible) {
				if(visible) {
					$("#fade").removeClass('invisible').addClass('fadeMe');
					$("#results").removeClass('invisible').addClass('visible');
				} else {
					$("#fade").removeClass('fadeMe').addClass('invisible');
					$("#results").removeClass('visible').addClass('invisible');
				}
			}

			function setHelpVisible(visible) {
				if(visible) {
					$("#fade").removeClass('invisible').addClass('fadeMe');
					$("#help").removeClass('invisible').addClass('help');
				} else {
					$("#fade").removeClass('fadeMe').addClass('invisible');
					$("#help").removeClass('visible').addClass('invisible');
				}
			}

			function isNumber(value) {
				value = value.toString().replace(",", ".");
				return value.toString().length != 0 && !isNaN(value);
			}

			function setFormTextVisible(visible, text) {
				if(visible) {
					$("#results").removeClass('visible').addClass('invisible');
					$("#formtext").removeClass('invisible').addClass('formtext');
					$("#copytext").text(eval(text));
					$("#copytext").focus();
					$("#copytext").select();
				} else {
					$("#results").removeClass('invisible').addClass('visible');
					$("#formtext").removeClass('formtext').addClass('invisible');
				}				
			}
			
			function setCopyText(totalWeight, mashVolume, mashBatchVolume, spargeVolume, totalWater, volumePreBoil, ig, volume, og)
			{
				var rt = "\r\n";
				
				textPlain = "> Ingredientes" + rt + rt;
				
				for (var i = 0; i < grainList.length; i++) 
				{
					textPlain += round(grainList[i].weight, 2) + " Kg    (" + grainList[i].percent + "%) " + grainList[i].name + rt;
				}
				
				textPlain += "----------------------" + rt;
				textPlain += "Total: " + round(totalWeight, 2) + " Kg" + rt;
				
				if (isNumber(mashVolume)) 
				{
					textPlain += rt + "> Macerado" + rt + rt;
					
					textPlain += "Agua para el macerado:  " + mashVolume + " litros." + rt;
					textPlain += "Volumen que ocupara el macerado:  " + mashBatchVolume + " litros." + rt;
					textPlain += "Agua para el lavado:  " + spargeVolume + " litros." + rt;
					textPlain += "Agua total necesaria:  " + totalWater + " litros." + rt;
				}
				
				if(isNumber(volumePreBoil)) 
				{
					textPlain += rt + "> Olla hervido" + rt + rt;
					
					textPlain += "Volumen de mosto en olla:  " + round(volumePreBoil, 1) + " litros." + rt;
					textPlain += "Densidad antes de hervir:  " + round(ig, 0) + rt;
				}
				
				textPlain += rt + "> Fermentador" + rt + rt;
					
				textPlain += "Volumen inicial:  " + round(volume, 1) + " litros." + rt;
				textPlain += "Densidad inicial:  " + round(og, 0);			
			}
						
			
		</script>
		<title>Calculadora Receta</title>
	</head>
	<body onload="populateGrainSeleccion()">
		<div id="fade" class="invisible"></div>

		<!-- RECETA -->
		<fieldset id="recipeToolLink">
			<legend>
				Receta
			</legend>
			<div class="values">

				<form name="recipeTool">
					<table id="grainTable"></table>
					<p>
						<nobr>
							<input class="data" type="text" name="hydrometer" value="" placeholder="Ej: 1.041 o 1041"/>
							Densidad inicial.
						</nobr>
					</p>
					<p>
						<nobr>
							<input class="data option" type="text" name="volume" value="" placeholder="Ej: 20" />
							Volumen inicial en litros.
						</nobr>
					</p>
					<p>
						<nobr>
							<input class="data option" type="text" name="efficiency" value="" placeholder="Ej: 75" />
							Rendimiento del equipo (%).
						</nobr>
					</p>
					<p>
						<nobr>
							<input class="data" type="text" name="mash" value="" placeholder="Ej: 3" />
							Relación de empaste para el macerado.
						</nobr>
					</p>
					<p>
						<nobr>
							<input class="data" type="text" name="boilTime" value="" placeholder="Ej: 90" />
							Tiempo de hervido (minutos)
						</nobr>
					</p>
					<p>
						<nobr>
							<input class="data" type="text" name="boilEvap" value="" placeholder="Ej: 4" />
							Perdida por evaporación en una hora (litros)
						</nobr>
					</p>

				</form>

				<input class="data" type="button" value="Calcular" onclick="recipeCalc();"/>
				<input class="data" type="button" value="Limpiar" onclick="recipeCalcClear();" />
				<a href="javascript:void(0)" onclick="setHelpVisible(true);">Ayuda</a>
			</div>
		</fieldset>

		<div id="results" class="invisible">
			<table class="results" id="maltResult"></table>

			<b>Macerado</b>
			<br/>
			<hr/>
			<table id="mashResult"></table>

			<b>Olla hervido</b>
			<br/>
			<hr/>
			<table id="boilResult"></table>

			<b>Fermentador</b>
			<br/>
			<hr/>
			<table id="ferResult"></table>
			<p>
				<nobr>
					<input class="data" type="button" value="Cerrar" onclick="setResultsVisible(false);"/>
					<input class="data" type="button" value="Copiar Texto" onclick="setFormTextVisible(true, 'textPlain');" />
				</nobr>
			</p>
		</div>

		<div id="help" class="invisible">
			<p>
				La calculadora de <b>Receta</b> esta orientado a las elaboraciones "todo grano" y permite realizar los siguiente cálculos:
			</p>
			<ul>
				<li>
					Cantidades de ingredientes.
				</li>
				<li>
					Cantidad de agua para el macerado. &#185;
				</li>
				<li>
					Volumen que ocupara el macerado. &#185;
				</li>
				<li>
					Agua necesaria para el lavado. &#185;
				</li>
				<li>
					Cantidad total de agua a usar. &#185;
				</li>
				<li>
					Volumen del mosto en olla. &#178;
				</li>
				<li>
					Densidad antes de hervir. &#178;
				</li>
				<li>
					Volumen inicial. &#179;
				</li>
				<li>
					Densidad inicial.
				</li>
			</ul>
			<i> (1) Estos datos solo se mostrarán si se indica relación de empaste del macerado
			<br/>
			(2) Estos datos solo se mostrarán si se indica el dato de evaporación y el tiempo de hervido.</br>
			(3) Aunque es un dato que se debe aportar para realizar el cálculo se muestra en el resumen de resultados.
			<br/>
			</i>
			<p>
				Deberemos conocer los siguientes datos de nuestro equipo:
			</p>
			<ul>
				<li>
					Rendimiento (%)
				</li>
			</ul>
			<p>
				Para el cálculo de la receta deberemos aportar:
			</p>
			<ul>
				<li>
					Ingredientes, expresados en porcentajes o pesos.
				</li>
				<li>
					Volumen inicial que queremos obtener en el fermentador.
				</li>
				<li>
					Densidad inicial. <i>Si no se indica se calculara.</i>
				</li>
			</ul>
			<p>
				Si para una relación de ingredientes indicamos solo pesos y no establecemos el valor de densidad inicial, entonces la densidad inicial
				se calculara de acuerdo a los ingredientes, rendimiento del equipo y volumen inicial que queremos obtener.
			</p>
			<p>
				Si indicamos pesos en los ingredientes y establecemos el valor de densidad inicial nos calculara el porcentaje de uso de cada uno de
				los ingredientes y en el resultado final se indicaran los pesos de los ingredientes que debemos usar. Esto nos servirá para redimensionar
				recetas que nos haya pasado con un volumen inicial distinto al que nosotros queremos obtener.
			</p>
			<p>
				Si se indica el porcentaje de los ingredientes entonces es obligatorio indicar la densidad inicial, sera un dato obligatorio para
				calcular el peso de cada ingrediente.
			</p>
			<p>
				En la calculadora no se tienen en cuenta los falsos fondos, perdidas en magueras, etc.. Se recomiendo leer
				el siguiente <a href="http://cerveceros-caseros.org/index.php/procesos/223-calculo-de-la-cantidad-de-agua">artículo</a>.
			</p>
			<input class="data" type="button" value="Cerrar" onclick="setHelpVisible(false);"/>
		</div>

		<div id="formtext" class="invisible">
			<p>
				Pulse CTRL + C para copiar el texto.
			</p>
			<textarea id ="copytext">Esto es una prueba
quiero probar la copia de texto
a ver como va.
      		</textarea>
			<input class="data closebutton" type="button" value="Cerrar" onclick="setFormTextVisible(false);"/>

		</div>
	</body>
</html>
